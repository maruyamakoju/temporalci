name: distributed-recovery-e2e

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

concurrency:
  group: distributed-recovery-e2e
  cancel-in-progress: false

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: temporalci
          POSTGRES_PASSWORD: temporalci
          POSTGRES_DB: temporalci
        ports:
          - 55432:5432
        options: >-
          --health-cmd "pg_isready -U temporalci -d temporalci"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
      redis:
        image: redis:7
        ports:
          - 56379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install distributed dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[distributed]"

      - name: Run distributed recovery proof
        run: |
          python scripts/distributed_recovery_e2e.py \
            --skip-compose \
            --postgres-dsn postgresql://temporalci:temporalci@localhost:55432/temporalci \
            --redis-url redis://localhost:56379/0 \
            --task-sleep-sec 10 \
            --completion-timeout-sec 300 \
            --wait-running-timeout-sec 120 \
            --artifacts-dir artifacts/distributed-recovery-e2e-ci

      - name: Upload distributed recovery artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: distributed-recovery-e2e-artifacts
          path: artifacts/distributed-recovery-e2e-ci
